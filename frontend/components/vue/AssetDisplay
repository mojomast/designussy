<template>
  <div :class="['uw-asset-display', theme, { empty: !asset, error: !!error }, className]" v-bind="$attrs">
    <!-- Empty State -->
    <div v-if="!asset" class="uw-empty-state">
      <div class="uw-empty-icon">üé®</div>
      <h3 class="uw-empty-title">No Asset Selected</h3>
      <p class="uw-empty-description">
        Generate an asset to see it displayed here
      </p>
    </div>

    <!-- Error State -->
    <div v-else-if="error" class="uw-error-state">
      <div class="uw-error-icon">‚ö†Ô∏è</div>
      <h3 class="uw-error-title">Failed to Load Asset</h3>
      <p class="uw-error-message">{{ error }}</p>
      <button
        type="button"
        class="uw-btn uw-btn-secondary"
        @click="retryLoad"
      >
        Retry
      </button>
    </div>

    <!-- Asset Display -->
    <div v-else class="uw-asset-content">
      <!-- Image Container -->
      <div class="uw-image-container">
        <div v-if="isLoading" class="uw-loading-overlay" role="status" aria-live="polite">
          <div class="uw-spinner" aria-hidden="true"></div>
          <span class="uw-loading-text">Loading asset...</span>
        </div>
        
        <img
          :src="asset.url"
          :alt="asset.alt || `${assetType} - ${assetDimensions}`"
          :class="['uw-asset-image', { loaded: imageLoaded }]"
          @load="handleImageLoad"
          @error="handleImageError"
          loading="lazy"
          :style="{ opacity: imageLoaded ? 1 : 0, transition: 'opacity 0.3s ease' }"
        />
      </div>

      <!-- Asset Actions -->
      <div class="uw-asset-actions">
        <div class="uw-action-buttons">
          <button
            v-if="allowDownload"
            type="button"
            class="uw-btn uw-btn-primary"
            @click="handleDownload"
            aria-label="Download asset"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              aria-hidden="true"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,15 17,10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Download
          </button>

          <button
            v-if="allowShare"
            type="button"
            class="uw-btn uw-btn-secondary"
            @click="handleShare"
            aria-label="Share asset"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              aria-hidden="true"
            >
              <circle cx="18" cy="5" r="3" />
              <circle cx="6" cy="12" r="3" />
              <circle cx="18" cy="19" r="3" />
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
            </svg>
            Share
          </button>

          <button
            v-if="allowDelete"
            type="button"
            class="uw-btn uw-btn-danger"
            @click="handleDelete"
            aria-label="Delete asset"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              aria-hidden="true"
            >
              <polyline points="3,6 5,6 21,6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </svg>
            Delete
          </button>
        </div>
      </div>

      <!-- Asset Metadata -->
      <div v-if="showMetadata && asset.metadata" class="uw-asset-metadata">
        <button
          type="button"
          class="uw-metadata-toggle"
          @click="toggleMetadata"
          :aria-expanded="showFullMetadata"
          aria-controls="uw-metadata-content"
        >
          <span class="uw-metadata-title">
            Asset Details
          </span>
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            aria-hidden="true"
            :style="{ transform: showFullMetadata ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s ease' }"
          >
            <polyline points="6,9 12,15 18,9" />
          </svg>
        </button>

        <div
          id="uw-metadata-content"
          :class="['uw-metadata-content', { expanded: showFullMetadata, collapsed: !showFullMetadata }]"
          :aria-hidden="!showFullMetadata"
        >
          <dl class="uw-metadata-list">
            <template v-if="asset.metadata.type">
              <dt>Type</dt>
              <dd>{{ asset.metadata.type }}</dd>
            </template>
            
            <template v-if="asset.metadata.dimensions">
              <dt>Dimensions</dt>
              <dd>{{ asset.metadata.dimensions }}</dd>
            </template>
            
            <template v-if="asset.metadata.size">
              <dt>Size</dt>
              <dd>{{ asset.metadata.size }}</dd>
            </template>
            
            <template v-if="asset.metadata.format">
              <dt>Format</dt>
              <dd>{{ asset.metadata.format }}</dd>
            </template>
            
            <template v-if="asset.metadata.generatedAt">
              <dt>Generated</dt>
              <dd>{{ formatDate(asset.metadata.generatedAt) }}</dd>
            </template>
            
            <template v-if="asset.metadata.prompt">
              <dt>Prompt</dt>
              <dd class="uw-prompt-text">{{ asset.metadata.prompt }}</dd>
            </template>
            
            <template v-if="asset.metadata.model">
              <dt>Model</dt>
              <dd>{{ asset.metadata.model }}</dd>
            </template>
            
            <template v-if="asset.tags && asset.tags.length > 0">
              <dt>Tags</dt>
              <dd class="uw-tags">
                <span v-for="(tag, index) in asset.tags" :key="index" class="uw-tag">
                  {{ tag }}
                </span>
              </dd>
            </template>
          </dl>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import { AssetFormatters } from '../utils/formatters.js';

// Props
const props = defineProps({
  asset: {
    type: Object,
    default: null
  },
  theme: {
    type: String,
    default: 'default',
    validator: (value) => ['default', 'dark', 'minimal', 'chaotic'].includes(value)
  },
  allowDownload: {
    type: Boolean,
    default: true
  },
  allowShare: {
    type: Boolean,
    default: true
  },
  allowDelete: {
    type: Boolean,
    default: false
  },
  showMetadata: {
    type: Boolean,
    default: true
  },
  className: {
    type: String,
    default: ''
  }
});

// Emits
const emit = defineEmits(['download', 'share', 'delete']);

// Reactive state
const isLoading = ref(true);
const error = ref(null);
const imageLoaded = ref(false);
const showFullMetadata = ref(false);

// Computed
const assetType = computed(() => {
  if (!props.asset) return '';
  return AssetFormatters.formatAssetType(props.asset.type || props.asset.metadata?.type);
});

const assetDimensions = computed(() => {
  if (!props.asset || !props.asset.metadata) return '';
  return props.asset.metadata.dimensions || `${props.asset.metadata.width} √ó ${props.asset.metadata.height}`;
});

// Methods
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString();
};

const handleImageLoad = () => {
  imageLoaded.value = true;
  isLoading.value = false;
};

const handleImageError = () => {
  error.value = 'Failed to load image';
  isLoading.value = false;
};

const handleDownload = () => {
  if (!props.asset) return;
  emit('download', props.asset);
};

const handleShare = () => {
  if (!props.asset) return;
  emit('share', props.asset);
};

const handleDelete = () => {
  if (!props.asset || !props.allowDelete) return;
  
  if (window.confirm('Are you sure you want to delete this asset?')) {
    emit('delete', props.asset);
  }
};

const toggleMetadata = () => {
  showFullMetadata.value = !showFullMetadata.value;
};

const retryLoad = () => {
  error.value = null;
  isLoading.value = true;
  imageLoaded.value = false;
};

// Watch for asset changes
watch(() => props.asset, (newAsset, oldAsset) => {
  if (newAsset !== oldAsset) {
    isLoading.value = true;
    error.value = null;
    imageLoaded.value = false;
    showFullMetadata.value = false;
  }
});
</script>

<style scoped>
.uw-asset-display {
  @apply bg-gray-900 text-white rounded-lg overflow-hidden;
}

.uw-empty-state,
.uw-error-state {
  @apply flex flex-col items-center justify-center p-8 text-center;
}

.uw-empty-icon,
.uw-error-icon {
  @apply text-6xl mb-4;
}

.uw-empty-title,
.uw-error-title {
  @apply text-xl font-semibold mb-2;
}

.uw-empty-description,
.uw-error-message {
  @apply text-gray-400 mb-4;
}

.uw-asset-content {
  @apply space-y-4;
}

.uw-image-container {
  @apply relative bg-gray-800 rounded-lg overflow-hidden;
}

.uw-loading-overlay {
  @apply absolute inset-0 flex flex-col items-center justify-center bg-gray-800 bg-opacity-90 z-10;
}

.uw-spinner {
  @apply w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin mb-2;
}

.uw-loading-text {
  @apply text-sm text-gray-300;
}

.uw-asset-image {
  @apply w-full h-auto max-h-96 object-contain;
  transition: opacity 0.3s ease;
}

.uw-asset-image.loaded {
  @apply opacity-100;
}

.uw-asset-image:not(.loaded) {
  @apply opacity-0;
}

.uw-asset-actions {
  @apply px-4 py-2;
}

.uw-action-buttons {
  @apply flex gap-3 flex-wrap;
}

.uw-btn {
  @apply flex items-center gap-2 px-3 py-2 rounded-md font-medium transition-colors;
}

.uw-btn-primary {
  @apply bg-blue-600 text-white hover:bg-blue-700;
}

.uw-btn-secondary {
  @apply bg-gray-600 text-white hover:bg-gray-700;
}

.uw-btn-danger {
  @apply bg-red-600 text-white hover:bg-red-700;
}

.uw-asset-metadata {
  @apply px-4 pb-4;
}

.uw-metadata-toggle {
  @apply flex items-center justify-between w-full p-2 bg-gray-800 rounded-md hover:bg-gray-700 transition-colors;
}

.uw-metadata-title {
  @apply font-medium;
}

.uw-metadata-content {
  @apply mt-2 transition-all duration-200;
}

.uw-metadata-content.collapsed {
  @apply max-h-0 overflow-hidden;
}

.uw-metadata-content.expanded {
  @apply max-h-96 overflow-y-auto;
}

.uw-metadata-list {
  @apply grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm;
}

.uw-metadata-list dt {
  @apply font-medium text-gray-300;
}

.uw-metadata-list dd {
  @apply text-white break-words;
}

.uw-prompt-text {
  @apply font-mono text-xs bg-gray-800 p-2 rounded border;
}

.uw-tags {
  @apply flex flex-wrap gap-1;
}

.uw-tag {
  @apply px-2 py-1 bg-gray-700 text-xs rounded-full;
}
</style>